const Discord= require ("./discord.js");
const config=require("./config.json")
const con = require('./dbconnect.js')

class Mobile_suit{

  constructor(id,model,lvl,hp,defense,strength,speed,manned) {
    //general constructor 

    this.id=id;
    this.model=model;
    this.lvl=lvl;
    this.hp=hp;
    this.defense=defense;
    this.strength =strength;
    this.speed=speed;
    this.manned=manned;
  }

  ////////////////////////////////////////
  //the following function is dedicated //
  //to adding mobile suit specs to the  //
  //mobile_suits database               //
  ////////////////////////////////////////
  add_MobileSuit(){ // may this function be the prototype for the rebuild.
   
    var exiting="UPDATE mobile_suits SET Manned=FALSE WHERE ID='"+this.id+"' AND Manned=TRUE";
    var row="INSERT INTO mobile_suits"+
    "(ID, Model, Lvl, Hp, Defense, Strength, Speed, Manned)"+
    "VALUES('"+this.id+"',"+"'"+this.model+
           "',"+this.lvl+","+this.hp+","+this.defense+
           ","+this.strength+","+this.speed+","+this.manned+")";

    try{
      con.query(exiting,(err,results)=>{
        if (err)console.log(err);
        else {
          console.log("Suits exited");
          con.query(row, (err, results)=>{
            if (err)console.log(err);
            else console.log("Row inserted");
          });
        }
      });
      
    }
    catch(e){
      console.log(e);
    }
    
  }

  ///////////////////////////////////////
  //the following function is untested //
  //but should work                    //
  ///////////////////////////////////////
  change_model(id,model_1,model_2){
    var row="INSERT INTO mobile_suits(Model)VALUES('"+model_2+"') WHERE Model='"+model_1+"'"

    con.query(row, (err, result)=>{
      if (err) throw err;
      else {
        console.log("\nmodel changed for id: "+id+
        "\n                            Model: "+model_1);
      }
    });
  }

  //////////////////////////////////
  // changes BOOL flag for manned //
  // collumn for speciific model  //
  //////////////////////////////////
  pilot_suit(id,model){
    
    var pilot="UPDATE mobile_suits SET Manned=TRUE WHERE id='"+id+"'AND model='"+model+"'"
    var exiting="UPDATE mobile_suits SET Manned=FALSE WHERE id='"+id+"' AND Manned=TRUE"

    try{
      con.query(exiting,(err,results)=>{
        if(err) console.log(err);
        else {
          console.log("Values in Manned changed to FALSE");
          con.query(pilot,(err, results)=>{
            if (err) console.log(err);
            else console.log("Selected value in Manned changed to TRUE");
          });
        }
      });
    }
    catch(e){
      console.log(e);
    }
  
  }

  ////////////////////////////////////////////////////////////////////
  //the follwing function needs to be repaired so that it returns a //
  //string with similar selection resuts to those that would be     //
  //to the console.                                                 //
  ////////////////////////////////////////////////////////////////////
  //successfully called fucntion
  //but it is giving me an ugly Object to JSON string
  //in a format that is straining to read
  //see command file showMeMySuits for refference
  //in the primary bot file sisodil.js
  search_ALLMobileSuits(id,callback){
    var select="SELECT * FROM mobile_suits WHERE id='"+id+"'"

    try{
      con.query(select,(err, results)=>{
        if (err) callback(err,null);
        else {
          // this will return the results(coverted to a json string) to the callback 
          callback(null, JSON.stringify(results)); // thank you JSON.stringify()

        };
      })
    }
    catch(e){
      console.log(e);
    };
  }

  //////////////////////////////////////////////////
  //
  /////////////////////////////////////////////////
  initiate_combat(id1,id2,bot,callback){
    var player_1="SELECT * FROM mobile_suits WHERE id='"+id1+"' AND Manned=TRUE"
    var player_2="SELECT * FROM mobile_suits WHERE id='"+id2+"' AND Manned=TRUE"

    var suit_1;
    var suit_2;
    var suits=[];
    var failure = false;

    try{
      con.query(player_1,(err,results)=>{
        if(err) callback(err,null);
        else if (results.length > 0){
          console.log();
          //parse results into  json string
          var str=JSON.stringify(results);
          console.log(str);
          //slice uneccessary brackets at beginning and end of string
          str=str.slice(1,-1);
          //parse new string into JSON object
          suit_1=JSON.parse(str);
          //now we have access to individual variables
          suits[0]=suit_1;
        }
        else{
          callback(null, failure)
        }
      });//end of query
    }//end of try
    catch(e){
      console.log(e);
    }
    try{
      con.query(player_2,(err,results)=>{
          if(err) callback(err,null);
          else if ( results.length > 0 ){
            var str=JSON.stringify(results);
            str=str.slice(1,-1);
            suit_2=JSON.parse(str);

            suits[1]=suit_2;
            // after the second query, the array containing
            // both json objects is returned to callback 
            // and subsequently the function caller
            callback(null,suits);
          }
          else{
            // this will return a false value
            // to use in a notification for the user
            callback(null, failure); 
          }
      })//end of query
    }//end of try
    catch(e){
      console.log(e);
    }
  }// end of initiate combat

  lvlUp(id, callback){
    var select = `SELECT * FROM mobile_suits WHERE id= ${id} AND Manned=TRUE`
  
    var suit;

    con.query(select,(err, results)=>{
        if (err) callback(err,null);
        else { 
          var str = JSON.stringify(results); // thank you JSON.stringify()
          str = str.slice(1,-1);
          suit = this.lvlUpMath(JSON.parse(str));
          console.log(`Updated suit math: `+suit);
          var update =`UPDATE mobile_suits SET Lvl=+'${suit.Lvl}' 
                       AND Hp='${suit.Hp}'
                       AND Defense='${suit.Defense}'
                       AND Strength='${suit.Strength}'
                       AND Speed='${suit.Speed}'
                       WHERE id= '${id}' 
                       AND Model='${suit.Model}'`
          con.query(update,(err,results)=>{
            if (err) callback(err,null);
            else{
              callback(null,JSON.stringify(results));
            }
          });
        };
      })
  }
  lvlUpMath(suit){
    suit.Lvl = (suit.Lvl + 1);
    suit.Hp= suit.Hp + (Math.floor(Math.random()*(100-90)+90));
    suit.Defense= suit.Defense + (Math.floor(Math.random()*(11-5)+5));
    suit.Strength= suit.Strength + (Math.floor(Math.random()*(11-5)+5));
    suit.Speed= suit.Speed + (Math.floor(Math.random()*(11-5)+5));
    return suit;
  }
}// end of class
module.exports=Mobile_suit;
